<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Игра с словами</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #222;
            font-family: Arial, sans-serif;
            touch-action: manipulation;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 60vh;
            min-height: 400px;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            border: 2px solid white;
            background-color: #000;
            display: block;
        }

        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: clamp(16px, 3vw, 24px);
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
        }

        #inputContainer {
            width: 100%;
            max-width: 800px;
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #textInput {
            width: 90%;
            max-width: 400px;
            padding: 15px;
            font-size: 18px;
            text-align: center;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            background-color: #333;
            color: white;
            text-transform: uppercase;
        }

        #textInput:focus {
            outline: none;
            border-color: #45a049;
            background-color: #444;
        }

        #currentInput {
            color: #4CAF50;
            font-size: 20px;
            margin: 10px 0;
            min-height: 25px;
            font-weight: bold;
        }

        #controls {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        #themeSelect {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            min-width: 120px;
        }

        #themeSelect:hover, #themeSelect:focus {
            background-color: #45a049;
            outline: none;
        }

        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            min-width: 100px;
            touch-action: manipulation;
        }

        button:hover, button:active {
            background-color: #45a049;
        }

        #endButton {
            background-color: #f44336;
        }

        #endButton:hover, #endButton:active {
            background-color: #da190b;
        }

        /* Виртуальная клавиатура для кириллицы */
        #virtualKeyboard {
            display: none;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            width: 100%;
            max-width: 600px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
        }

        .key {
            padding: 10px 5px;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
            min-height: 40px;
        }

        .key:hover, .key:active {
            background-color: #666;
        }

        .key.backspace {
            grid-column: span 2;
            background-color: #f44336;
        }

        .key.backspace:hover, .key.backspace:active {
            background-color: #da190b;
        }

        #toggleKeyboard {
            background-color: #2196F3;
            margin-top: 10px;
        }

        #toggleKeyboard:hover, #toggleKeyboard:active {
            background-color: #1976D2;
        }

        @media (max-width: 600px) {
            body {
                padding: 5px;
            }
            
            #gameContainer {
                height: 50vh;
            }
            
            #controls {
                flex-direction: column;
                align-items: center;
            }
            
            #virtualKeyboard {
                grid-template-columns: repeat(8, 1fr);
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="score">Очки: 0 (Уровень 1)</div>
    </div>
    
    <div id="inputContainer">
        <input type="text" id="textInput" placeholder="Введите слово..." autocomplete="off" autocorrect="off" spellcheck="false">
        <div id="currentInput"></div>
    </div>
    
    <div id="controls">
        <select id="themeSelect">
            <option value="cities">Столицы</option>
            <option value="footballers">Футболисты</option>
        </select>
        <button id="startButton">Старт</button>
        <button id="pauseButton">Пауза</button>
        <button id="endButton">Завершение</button>
        <button id="toggleKeyboard">Клавиатура</button>
    </div>
    
    <div id="virtualKeyboard"></div>

    <script>
        // Particle class
        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = Math.random() * 5 + 2;
                this.speedX = (Math.random() - 0.5) * 4;
                this.speedY = (Math.random() - 0.5) * 4;
                this.life = 30;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.life--;
            }

            draw(ctx) {
                ctx.fillStyle = `rgba(255, 165, 0, ${this.life / 30})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Word class
        class Word {
            constructor(text, x, imgSrc) {
                this.text = text.toUpperCase();
                this.x = x;
                this.y = 0;
                this.speed = 0.3;
                this.imgSrc = imgSrc;
                this.image = new Image();
                this.image.src = imgSrc;
                this.particles = [];
                this.exploding = false;
            }

            update() {
                if (this.exploding) {
                    this.particles.forEach(p => p.update());
                    this.particles = this.particles.filter(p => p.life > 0);
                } else {
                    this.y += this.speed;
                }
            }

            draw(ctx, input) {
                if (this.exploding) {
                    this.particles.forEach(p => p.draw(ctx));
                    return;
                }

                const canvas = ctx.canvas;
                let scaledHeight = 0;
                
                if (this.image.complete && this.image.naturalWidth !== 0) {
                    const maxSize = Math.min(canvas.width * 0.25, 150);
                    const width = this.image.width;
                    const height = this.image.height;
                    const scale = Math.min(maxSize / width, maxSize / height);
                    const scaledWidth = width * scale;
                    scaledHeight = height * scale;
                    ctx.drawImage(this.image, this.x - scaledWidth / 2, this.y - scaledHeight / 2, scaledWidth, scaledHeight);
                } else {
                    const size = Math.min(canvas.width * 0.25, 100);
                    ctx.fillStyle = 'lightgray';
                    ctx.fillRect(this.x - size / 2, this.y - size / 2, size, size);
                    ctx.fillStyle = 'black';
                    ctx.font = `${size * 0.3}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText('?', this.x, this.y + size * 0.1);
                    scaledHeight = size;
                }

                // Отображение текста с учетом размера экрана
                const fontSize = Math.max(16, canvas.width * 0.03);
                ctx.font = `${fontSize}px Arial`;
                ctx.textAlign = 'center';
                
                const inputUpper = input.toUpperCase();
                let matchedLength = 0;
                for (let i = 0; i < inputUpper.length && i < this.text.length; i++) {
                    if (inputUpper[i] === this.text[i]) matchedLength++;
                    else break;
                }
                
                const textY = this.y + scaledHeight / 2 + fontSize + 10;
                
                // Отображаем текст по буквам
                for (let i = 0; i < this.text.length; i++) {
                    ctx.fillStyle = i < matchedLength ? 'lime' : 'white';
                    const charWidth = fontSize * 0.6;
                    const textX = this.x + (i * charWidth) - (this.text.length * charWidth / 2);
                    ctx.fillText(this.text[i], textX, textY);
                }
            }

            explode() {
                this.exploding = true;
                for (let i = 0; i < 20; i++) {
                    this.particles.push(new Particle(this.x, this.y));
                }
            }
        }

        // Game class
        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.textInput = document.getElementById('textInput');
                this.currentInputDiv = document.getElementById('currentInput');
                
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                this.words = [];
                this.score = 0;
                this.level = 1;
                this.spawnDelay = 2000;
                this.lastSpawn = 0;
                this.input = '';
                this.currentTheme = 'cities';
                this.isPaused = false;
                this.gameStarted = false;
                
                // Демо данные (в реальной игре загружаются из файлов)
                this.themes = {
                    'cities': [
                        { capital: 'МОСКВА', code: 'RU' },
                        { capital: 'ПАРИЖ', code: 'FR' },
                        { capital: 'ЛОНДОН', code: 'GB' },
                        { capital: 'БЕРЛИН', code: 'DE' },
                        { capital: 'РИМ', code: 'IT' },
                        { capital: 'МАДРИД', code: 'ES' },
                        { capital: 'КИЕВ', code: 'UA' },
                        { capital: 'ВАРШАВА', code: 'PL' }
                    ],
                    'footballers': [
                        { name: 'МЕССИ' },
                        { name: 'РОНАЛДУ' },
                        { name: 'НЕЙМАР' },
                        { name: 'МБАППЕ' },
                        { name: 'ХОЛАНД' }
                    ]
                };
                
                this.wordMapping = {
                    cities: {
                        'МОСКВА': 'ru',
                        'ПАРИЖ': 'fr',
                        'ЛОНДОН': 'gb',
                        'БЕРЛИН': 'de',
                        'РИМ': 'it',
                        'МАДРИД': 'es',
                        'КИЕВ': 'ua',
                        'ВАРШАВА': 'pl'
                    },
                    footballers: {
                        'МЕССИ': 'messi',
                        'РОНАЛДУ': 'ronaldo',
                        'НЕЙМАР': 'neymar',
                        'МБАППЕ': 'mbappe',
                        'ХОЛАНД': 'haaland'
                    }
                };
                
                this.setupControls();
                this.setupVirtualKeyboard();
            }

            resizeCanvas() {
                const container = document.getElementById('gameContainer');
                const rect = container.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
            }

            setupControls() {
                const themeSelect = document.getElementById('themeSelect');
                themeSelect.addEventListener('change', e => {
                    this.currentTheme = e.target.value;
                    this.endGame();
                });

                document.getElementById('startButton').addEventListener('click', () => {
                    if (!this.gameStarted) {
                        this.gameStarted = true;
                        this.gameLoop();
                    }
                    this.isPaused = false;
                });

                document.getElementById('pauseButton').addEventListener('click', () => {
                    this.pauseGame();
                });

                document.getElementById('endButton').addEventListener('click', () => {
                    this.endGame();
                });

                // Input handling
                this.textInput.addEventListener('input', (e) => {
                    if (this.isPaused || !this.gameStarted) return;
                    
                    this.input = e.target.value.toUpperCase();
                    this.currentInputDiv.textContent = this.input;
                    
                    // Проверка соответствия
                    if (this.words.length > 0) {
                        const target = this.words[0].text;
                        if (!target.startsWith(this.input)) {
                            this.input = '';
                            this.textInput.value = '';
                            this.currentInputDiv.textContent = '';
                            return;
                        }
                    }
                    
                    this.checkInput();
                });

                this.textInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.checkInput();
                    }
                });

                // Предотвращаем потерю фокуса
                this.textInput.addEventListener('blur', () => {
                    if (this.gameStarted && !this.isPaused) {
                        setTimeout(() => this.textInput.focus(), 100);
                    }
                });
            }

            setupVirtualKeyboard() {
                const keyboard = document.getElementById('virtualKeyboard');
                const toggleBtn = document.getElementById('toggleKeyboard');
                
                const russianKeys = [
                    'Й', 'Ц', 'У', 'К', 'Е', 'Н', 'Г', 'Ш', 'Щ', 'З',
                    'Ф', 'Ы', 'В', 'А', 'П', 'Р', 'О', 'Л', 'Д', 'Ж',
                    'Я', 'Ч', 'С', 'М', 'И', 'Т', 'Ь', 'Б', 'Ю', 'Х'
                ];

                russianKeys.forEach(key => {
                    const button = document.createElement('button');
                    button.className = 'key';
                    button.textContent = key;
                    button.addEventListener('click', () => {
                        if (this.isPaused || !this.gameStarted) return;
                        this.textInput.value += key;
                        this.textInput.dispatchEvent(new Event('input'));
                        this.textInput.focus();
                    });
                    keyboard.appendChild(button);
                });

                // Backspace key
                const backspaceBtn = document.createElement('button');
                backspaceBtn.className = 'key backspace';
                backspaceBtn.textContent = '⌫';
                backspaceBtn.addEventListener('click', () => {
                    if (this.isPaused || !this.gameStarted) return;
                    this.textInput.value = this.textInput.value.slice(0, -1);
                    this.textInput.dispatchEvent(new Event('input'));
                    this.textInput.focus();
                });
                keyboard.appendChild(backspaceBtn);

                toggleBtn.addEventListener('click', () => {
                    if (keyboard.style.display === 'none' || keyboard.style.display === '') {
                        keyboard.style.display = 'grid';
                        toggleBtn.textContent = 'Скрыть клавиатуру';
                    } else {
                        keyboard.style.display = 'none';
                        toggleBtn.textContent = 'Клавиатура';
                    }
                });
            }

            getImagePath(word) {
                // В демо версии возвращаем заглушку
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JTUFHRTwvdGV4dD48L3N2Zz4=';
            }

            spawnWord() {
                const themeData = this.themes[this.currentTheme];
                if (!themeData.length || this.words.length) return;

                const randomItem = themeData[Math.floor(Math.random() * themeData.length)];
                const wordText = this.currentTheme === 'cities' ? randomItem.capital : randomItem.name;
                const imgSrc = this.getImagePath(wordText);

                const minX = this.canvas.width * 0.2;
                const maxX = this.canvas.width * 0.8;
                const x = minX + Math.random() * (maxX - minX);

                const word = new Word(wordText, x, imgSrc);
                word.speed = 0.3 + (this.level - 1) * 0.2;
                this.words.push(word);
            }

            gameLoop() {
                if (this.isPaused || !this.gameStarted) return;
                
                const now = Date.now();
                if (now - this.lastSpawn > this.spawnDelay) {
                    this.spawnWord();
                    this.lastSpawn = now;
                }
                
                this.update();
                this.draw();
                requestAnimationFrame(() => this.gameLoop());
            }

            update() {
                this.words.forEach((word, idx) => {
                    word.update();
                    if (word.exploding && !word.particles.length) {
                        this.words.splice(idx, 1);
                        this.spawnWord();
                    } else if (!word.exploding && word.y > this.canvas.height) {
                        this.words.splice(idx, 1);
                    }
                });

                if (this.score >= 50 && this.level === 1) {
                    this.level = 2;
                    this.words.forEach(w => w.speed = 0.6);
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.words.forEach(w => w.draw(this.ctx, this.input));
                document.getElementById('score').textContent = `Очки: ${this.score} (Уровень ${this.level})`;
            }

            checkInput() {
                if (!this.words.length || !this.input) return;
                
                if (this.words[0].text === this.input) {
                    this.words[0].explode();
                    this.score += 10;
                    this.input = '';
                    this.textInput.value = '';
                    this.currentInputDiv.textContent = '';
                }
            }

            pauseGame() {
                this.isPaused = !this.isPaused;
                if (this.isPaused) {
                    this.input = '';
                    this.textInput.value = '';
                    this.currentInputDiv.textContent = '';
                } else if (this.gameStarted) {
                    this.textInput.focus();
                    this.gameLoop();
                }
            }

            endGame() {
                this.isPaused = true;
                this.gameStarted = false;
                this.words = [];
                this.score = 0;
                this.level = 1;
                this.input = '';
                this.textInput.value = '';
                this.currentInputDiv.textContent = '';
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                document.getElementById('score').textContent = `Очки: 0 (Уровень 1)`;
            }
        }

        // Инициализация игры
        const game = new Game();
        
        // Предотвращение зума при двойном тапе
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>